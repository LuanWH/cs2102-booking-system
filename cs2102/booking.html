<!DOCTYPE html>      
<html>   

  <head>

    <title>Ticket Booking</title>
    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <script src="js/jquery.min.js"></script>

  </head>
  <body>
    <div class="table-responsive">
      <div id = "bookTicketContainer">
        <font style = "font-size:30px">Book Your Tickets</font>
        <form>
          <p>UserID: <input type="text" name="name" id="UserID"> <span style="color:red" id="UserIDMsgContainer"></span></p>
           
          <br>
          <p>Cinema: </p>
          <select id="Cinema" name="cinema"> 
            <option value="">Select Cinema</option>
          </select>
          <div id = "CinemaMsgContainer"></div>
          <br>

          <p>Movie: </p>
          <select id="Movie" name = "movie"> 
            <option value="">Select Movie</option>
          </select>
          <div id = "MovieMsgContainer"></div>
          <br>
          <p>Timeslot: </p>
          <select id="Timeslot" name="timeslot"> 
            <option value="">Select Timeslot</option>
          </select>
          <div id = "TimeslotMsgContainer"></div>
          <br>        

          <button onclick = "bookTicket()">Book!</button>
        </form>
      </div>
    </div>
    <script type="text/javascript">
      function bookTicket(){

        var hasCinema = $('#Cinema').val() != null && $('#Cinema').val() != "";
        var hasMovie = $('#Movie').val() != null && $('#Movie').val() != "";
        var hasTimeslot = $('#Timeslot').val() != null && $('#Timeslot').val() != "";
        var hasUserID = $('#UserID').val()!=null && $('userID').val() != "";
        var hasValidUserID = hasUserID && !isNaN($('UserID').val());

        if(!hasCinema){
          $('#CinemaMsgContainer').html('<p style="color:red">Please choose a cinema!</p>');
        } else {
          $('#CinemaMsgContainer').empty();
        }

        if(!hasMovie){
          $('#MovieMsgContainer').html('<p style="color:red">Please choose a movie!</p>');
        }else{
          $('#MovieMsgContainer').empty();
        }

        if(!hasTimeslot){
          $('#TimeslotMsgContainer').html('<p style="color:red">Please choose a timeslot!</p>')
        } else {
          $('#TimeslotMsgContainer').empty();
        }

        if(hasUserID && !hasValidUserID){
          $('#UserIDMsgContainer').html('Please enter a valid user ID!');
        } else if(!hasUserID){
          $('#UserIDMsgContainer').html('Please enter a user ID!');
        } else {
          $('#UserIDMsgContainer').empty();
        }

        if(hasCinema&&hasMovie&&hasTimeslot&&hasUserID&&hasValidUserID&&timeSlotMap!=null){
          $.ajax({
            url:'bookResult.php',
            type: 'post',
            data: {
                    'cinemaName': $('#Cinema').val(),
                    'movieTitle': $('#Movie').val(),
                    'userID': $('#UserName').val(),
                    'startTime': timeSlotMap[0],
                    'endTime': timeSlotMap[1],
                    'hallID': timeSlotMap[2]
                  },
          });
        }
      }


      var timeSlotMap = [];
      function fetchTimeslots(cinemaName, movieTitle){
        if(cinemaName != null && cinemaName != "" &&
           movieTitle != null && movieTitle != ""){
          $.ajax({
            url:'fetchTimeslots.php',
            type: 'post',
            data: {'cinemaName': cinemaName,
                   'movieTitle': movieTitle},
            dataType: 'text',
            success: function (response) {
              timeSlotMap = eval(response);
              $('#Timeslot').empty();
              $('#TimeslotMsgContainer').empty();
              $('#Timeslot').html('<option value=\""\"">Select Timeslot</option>');
              for(var i = 0; i < timeSlotMap.length; i++){
                $('#Timeslot').append('<option value='+i+'>'+
                                    timeSlotMap[i].startTime+' to '+
                                    timeSlotMap[i].endTime + ' at hall '+
                                    timeSlotMap[i].hallID+'</option>');
              }
            },
            error: function () {
              $('#Timeslot').empty();
              $('#Timeslot').html('<option value=\""\"">Select Timeslot</option>');
              $('#TimeslotMsgContainer').html('<p>Error when fetching timeslot data.</p>');
            }
          });           
        }
              $('#Timeslot').empty();
              $('#Timeslot').html('<option value=\""\"">Select Timeslot</option>');        
      }

      function fetchMovies(cinemaName) {
        if(cinemaName != null && cinemaName != ""){
          $.ajax({
            url:'fetchMovies.php',
            type: 'post',
            data: {'cinemaName': cinemaName},
            success: function (response) {
              $('#Movie').empty();
              $('#Movie').html('<option value=\""\"">Select Movie</option>');
              $('#Movie').append(response);
              $('#MovieMsgContainer').empty();
            },
            error: function () {
              $('#Movie').empty();
              $('#Movie').html('<option value=\""\"">Select Movie</option>');
              $('#MovieMsgContainer').html('<p>Error when fetching cinema ' + cinemaName + ' movie data.</p>');
            }
          });          
        } else {
              $('#Movie').empty();
              $('#Movie').html('<option value=\""\"">Select Movie</option>');          
        }
        return true;
      }

      function fetchCinemas() {

          $.ajax({
            url:'fetchCinemas.php',
            dataType: 'text',
            success: function (response) {
              $('#Cinema').empty();
              $('#Cinema').html('<option value=\""\"">Select Cinema</option>');
              $('#Cinema').append(response);
              $('#CinemaMsgContainer').empty();
            },
            error: function (ignore0, ignore1, ignore2) {
              $('#Cinema').empty();
              $('#Cinema').html('<option value=\""\"">Select Cinema</option>');
              $('#CinemaMsgContainer').append('<p>Error when fetching cinema data.</p>');
            }
          });                
        }

      $(document).ready(function(){

        fetchCinemas();

        $( "#Cinema" ).change(function() {
          var selectedCinema = $('#Cinema').val();
          fetchMovies(selectedCinema);
          fetchTimeslots(null,null);
        });

        $("#Movie").change(function(){
          var selectedMovie = $('#Movie').val();
          var selectedCinema = $('#Cinema').val();
          fetchTimeslots(selectedCinema, selectedMovie);
        });
      });
    </script>    
  </body> 

</html>            